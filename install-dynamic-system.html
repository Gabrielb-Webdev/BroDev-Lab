<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Instalador Sistema Din√°mico - BroDev Lab</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a0b2e 0%, #16213e 100%);
            color: #ffffff;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .installer-container {
            max-width: 800px;
            width: 100%;
            background: rgba(30, 20, 60, 0.95);
            border: 2px solid rgba(124, 58, 237, 0.4);
            border-radius: 16px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .header h1 {
            font-size: 2.5rem;
            background: linear-gradient(135deg, #7c3aed, #3b82f6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #94a3b8;
            font-size: 1.1rem;
        }
        
        .feature-list {
            background: rgba(26, 11, 46, 0.7);
            border: 2px solid rgba(124, 58, 237, 0.3);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
        }
        
        .feature-list h2 {
            color: #7c3aed;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }
        
        .feature-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .feature-icon {
            font-size: 1.5rem;
            flex-shrink: 0;
        }
        
        .feature-text {
            flex: 1;
        }
        
        .feature-text strong {
            color: #ffffff;
            display: block;
            margin-bottom: 4px;
        }
        
        .feature-text span {
            color: #94a3b8;
            font-size: 0.9rem;
        }
        
        .install-btn {
            width: 100%;
            padding: 16px 32px;
            background: linear-gradient(135deg, #7c3aed, #3b82f6);
            border: none;
            border-radius: 12px;
            color: #ffffff;
            font-size: 1.2rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }
        
        .install-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(124, 58, 237, 0.5);
        }
        
        .install-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        #installOutput {
            background: #000000;
            border: 2px solid rgba(124, 58, 237, 0.3);
            border-radius: 12px;
            padding: 20px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            max-height: 400px;
            overflow-y: auto;
            display: none;
        }
        
        #installOutput.show {
            display: block;
        }
        
        .log-line {
            margin-bottom: 8px;
        }
        
        .log-success {
            color: #22c55e;
        }
        
        .log-error {
            color: #ef4444;
        }
        
        .log-info {
            color: #60a5fa;
        }
        
        .log-warning {
            color: #f59e0b;
        }
        
        .warning-box {
            background: rgba(245, 158, 11, 0.1);
            border: 2px solid rgba(245, 158, 11, 0.4);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .warning-box h3 {
            color: #f59e0b;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .warning-box ul {
            margin-left: 20px;
            color: #fbbf24;
        }
        
        .warning-box li {
            margin-bottom: 8px;
        }
    </style>
</head>
<body>
    <div class="installer-container">
        <div class="header">
            <h1>üöÄ Sistema Din√°mico Avanzado</h1>
            <p>Instalador de Campos Customizables y Sincronizaci√≥n en Tiempo Real</p>
        </div>
        
        <div class="feature-list">
            <h2>‚ú® Nuevas Funcionalidades</h2>
            
            <div class="feature-item">
                <div class="feature-icon">üìä</div>
                <div class="feature-text">
                    <strong>Tablas Din√°micas</strong>
                    <span>Agrega, elimina y reordena columnas como en Excel. Completamente customizable.</span>
                </div>
            </div>
            
            <div class="feature-item">
                <div class="feature-icon">üîß</div>
                <div class="feature-text">
                    <strong>21 Tipos de Campos</strong>
                    <span>Texto, n√∫mero, dropdown, fecha, email, tel√©fono, moneda, calificaci√≥n, color, y m√°s.</span>
                </div>
            </div>
            
            <div class="feature-item">
                <div class="feature-icon">‚úèÔ∏è</div>
                <div class="feature-text">
                    <strong>Edici√≥n Inline</strong>
                    <span>Edita directamente en la tabla sin modales. Guarda autom√°ticamente al cambiar.</span>
                </div>
            </div>
            
            <div class="feature-item">
                <div class="feature-icon">üîÑ</div>
                <div class="feature-text">
                    <strong>Sincronizaci√≥n en Tiempo Real</strong>
                    <span>Polling cada 3 segundos. Los cambios de tu equipo aparecen autom√°ticamente.</span>
                </div>
            </div>
            
            <div class="feature-item">
                <div class="feature-icon">üíæ</div>
                <div class="feature-text">
                    <strong>Vistas Personalizadas</strong>
                    <span>Guarda diferentes configuraciones de columnas y filtros.</span>
                </div>
            </div>
            
            <div class="feature-item">
                <div class="feature-icon">üìú</div>
                <div class="feature-text">
                    <strong>Historial de Cambios</strong>
                    <span>Auditor√≠a completa de todas las modificaciones con fecha y usuario.</span>
                </div>
            </div>
            
            <div class="feature-item">
                <div class="feature-icon">üé®</div>
                <div class="feature-text">
                    <strong>Validaci√≥n Avanzada</strong>
                    <span>Reglas de validaci√≥n por tipo de campo. Campos obligatorios.</span>
                </div>
            </div>
            
            <div class="feature-item">
                <div class="feature-icon">üîó</div>
                <div class="feature-text">
                    <strong>Relaciones Entre Tablas</strong>
                    <span>Conecta proyectos con clientes, tareas y m√°s.</span>
                </div>
            </div>
        </div>
        
        <div class="warning-box">
            <h3>‚ö†Ô∏è Antes de Instalar</h3>
            <ul>
                <li>Se crear√°n 9 nuevas tablas en la base de datos</li>
                <li>Se insertar√°n campos predeterminados para Proyectos y Clientes</li>
                <li>Se habilitar√° el sistema de sincronizaci√≥n autom√°tica</li>
                <li>Haz un backup de tu base de datos antes de continuar</li>
            </ul>
        </div>
        
        <button class="install-btn" onclick="startInstallation()">
            üöÄ Instalar Sistema Din√°mico
        </button>
        
        <div id="installOutput"></div>
    </div>
    
    <script>
        async function startInstallation() {
            const btn = document.querySelector('.install-btn');
            const output = document.getElementById('installOutput');
            
            btn.disabled = true;
            btn.textContent = '‚è≥ Instalando...';
            output.classList.add('show');
            output.innerHTML = '';
            
            addLog('info', 'üöÄ Iniciando instalaci√≥n del sistema din√°mico...');
            addLog('info', '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
            
            try {
                // Leer el archivo SQL
                addLog('info', 'üìñ Leyendo script de base de datos...');
                const response = await fetch('../database-custom-fields.sql');
                const sqlContent = await response.text();
                
                // Dividir en statements individuales
                const statements = sqlContent
                    .split(';')
                    .map(s => s.trim())
                    .filter(s => s.length > 0 && !s.startsWith('--'));
                
                addLog('success', `‚úÖ ${statements.length} operaciones SQL detectadas`);
                addLog('info', '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
                
                // Ejecutar cada statement
                let successCount = 0;
                let errorCount = 0;
                
                for (let i = 0; i < statements.length; i++) {
                    const statement = statements[i];
                    
                    // Detectar tipo de operaci√≥n
                    let operation = 'Ejecutando';
                    if (statement.toUpperCase().includes('CREATE TABLE')) {
                        const tableName = statement.match(/CREATE TABLE.*?`?(\w+)`?/i)?.[1];
                        operation = `üì¶ Creando tabla: ${tableName}`;
                    } else if (statement.toUpperCase().includes('INSERT INTO')) {
                        const tableName = statement.match(/INSERT INTO.*?`?(\w+)`?/i)?.[1];
                        operation = `üìù Insertando datos en: ${tableName}`;
                    }
                    
                    addLog('info', `[${i + 1}/${statements.length}] ${operation}`);
                    
                    try {
                        const result = await fetch('install-dynamic-system.php', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ sql: statement })
                        });
                        
                        const data = await result.json();
                        
                        if (data.success) {
                            successCount++;
                            addLog('success', `   ‚úì Completado`);
                        } else {
                            // No es error si la tabla ya existe
                            if (data.error && data.error.includes('already exists')) {
                                addLog('warning', `   ‚ö† Ya existe, omitiendo`);
                            } else {
                                errorCount++;
                                addLog('error', `   ‚úó Error: ${data.error}`);
                            }
                        }
                    } catch (error) {
                        errorCount++;
                        addLog('error', `   ‚úó Error de red: ${error.message}`);
                    }
                    
                    // Peque√±a pausa para visualizaci√≥n
                    await sleep(100);
                }
                
                addLog('info', '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
                
                if (errorCount === 0) {
                    addLog('success', `üéâ ¬°INSTALACI√ìN COMPLETADA EXITOSAMENTE!`);
                    addLog('success', `‚úÖ ${successCount} operaciones ejecutadas correctamente`);
                    addLog('info', '');
                    addLog('info', 'üî• Sistema din√°mico activado. Caracter√≠sticas disponibles:');
                    addLog('info', '   ‚Ä¢ Tabla din√°mica con edici√≥n inline');
                    addLog('info', '   ‚Ä¢ 21 tipos de campos customizables');
                    addLog('info', '   ‚Ä¢ Sincronizaci√≥n en tiempo real (3s)');
                    addLog('info', '   ‚Ä¢ Historial de cambios completo');
                    addLog('info', '   ‚Ä¢ Vistas personalizadas');
                    addLog('info', '');
                    addLog('success', 'üöÄ Recarga la p√°gina del admin panel para ver los cambios');
                    
                    btn.textContent = '‚úÖ Instalaci√≥n Completada';
                    btn.style.background = 'linear-gradient(135deg, #22c55e, #10b981)';
                } else {
                    addLog('warning', `‚ö†Ô∏è Instalaci√≥n completada con ${errorCount} advertencias`);
                    addLog('success', `‚úÖ ${successCount} operaciones exitosas`);
                    addLog('info', '');
                    addLog('info', 'Las advertencias son normales si ya instalaste anteriormente.');
                    addLog('info', 'Si es tu primera instalaci√≥n, revisa los errores arriba.');
                    
                    btn.textContent = '‚ö†Ô∏è Completado con Advertencias';
                    btn.style.background = 'linear-gradient(135deg, #f59e0b, #d97706)';
                }
            } catch (error) {
                addLog('error', `‚ùå ERROR CR√çTICO: ${error.message}`);
                btn.textContent = '‚ùå Error en Instalaci√≥n';
                btn.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
            }
        }
        
        function addLog(type, message) {
            const output = document.getElementById('installOutput');
            const line = document.createElement('div');
            line.className = `log-line log-${type}`;
            line.textContent = message;
            output.appendChild(line);
            output.scrollTop = output.scrollHeight;
        }
        
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
    </script>
</body>
</html>
